# IOT2050 secure boot customer key provisioning

IOT2050 Advanced PG2 enables the SoC extend OTP area for storing the customer
key used for signing the firmware & software that validated by SEBoot and afterwards.

Below are the steps to programming keys into this OTP area.

## Create the keys

First, you need to generate at least two sets of key pair under the folder
`files/keys`. At most you can have three key pair sets. An example of key pairs
are already there for reference.

These keys are named `MPK`, `SMPK` and `BMPK` respectively.

- `MPK`: the first key for signing customized firmware and image.
- `SMPK`: the second key for signing customized firmware and image. If unfortunately
the first key is leaked, user can switch to use this key.
- `BMPK`: the third key for signing customized firmware and image. If unfortunately
the second keys is leaked as well, user can switch to use this key.

```shell
openssl req -x509 -newkey rsa:4096 -keyout custMpk.pem -nodes -outform pem -out custMpk.crt -sha256
openssl req -x509 -newkey rsa:4096 -keyout custSmpk.pem -nodes -outform pem -out custSmpk.crt -sha256
# optional the third key
#openssl req -x509 -newkey rsa:4096 -keyout custBmpk.pem -nodes -outform pem -out custBmpk.crt -sha256
```

> :warning:
> Do remove the example dummy keys under the keys folder!

## OTP programming

The OTP programming data is generated by running the script `files/make-otpcmd.sh`.
The generated `otpcmd.bin` should be programmed into the flash, and during the
next booting, the first stage bootloader (SEBoot) will detect it and will try to
program it into the OTP area.

To ease the key provisioning tasks, we provided an example firmware image in
this repo to build an image containing both:

- the otpcmd.bin
- signed firmware

so that the first booting of signed firmware and OTP programming could be combined
together.

You can make your own implement based on this blueprint, or you can use the script
directly.

### Building the signed firmware image containing the key provisioning data

The next step is to build the signed firmware image together with the key
provisioning data.

Before start the build, make sure the currently using key set is copied to
`recipes-bsp/u-boot/files/keys/custMpk.pem`.

```shell
./kas-container build kas-iot2050-boot-pg2.yml:kas/opt/secure-boot.yml:kas/opt/otpcmd/key-provision.yml
```

> Warning: The default key sets within kas/opt/key-provision.yml only contain
> MPK and SMPK. To include BMPK as well, please refer to
[Flexible key provisioning](#flexible-key-provisioning).

### Update the firmware to provisioning the keys

Copy the built firmware image to IOT2050 and run the firmware update against the
new firmware image:

```shell
iot2050-firmware-update -f iot2050-pg2-image-boot.bin
```

Reboot the IOT2050 and follow the instruction on the device. The debug serial
port has to be connected to give your consent to the provisioning routine.

> Warning: after provisioning, all application must be signed with the currently
> using key.

The key provisioning just need be run once. Later secure boot firmware building
should drop the `kas/opt/key-provision.yml`

### Revoke a leaked currently in-use key

If unfortunately the currently using key is leaked, you could switch to use the
next keysets as the effective one.

First make sure the new key is copied to `recipes-bsp/u-boot/files/keys/custMpk.pem`.

Then start to building the new key signed firmware together with the key switching
otpcmd data.

```shell
./kas-container build kas-iot2050-boot-pg2.yml:kas/opt/secure-boot.yml:kas/opt/otpcmd/key-switch.yml
```

> Warning: The default switching within kas/opt/key-switch.yml is from MPK to SMPK.
> If you want to switch from SMPK to BMPK, please refer to
[Flexible key provisioning](#flexible-key-provisioning).

Then follow the exact same steps as defined in above, to update the firmware and
follow the instructions on device after rebooting.

## Flexible key provisioning

The otpcmd data produced by the default `kas/opt/key-provision.yml` contains

- the MPK and SMPK key sets
- control bit that enabling the secure boot

Sometimes it would be helpful to have different configurations. This could be done
by feeding different kas option file to the building.

### Provision the additional BMPK

If the BMPK need to be programmed together:

```bash
./kas-container build kas-iot2050-boot-pg2.yml:kas/opt/secure-boot.yml:kas/opt/otpcmd/key-provision-3keys.yml
```

### Provision keys only without enabling secure boot

If only the keys need to be programmed but not enabling the secure boot:

```bash
./kas-container build kas-iot2050-boot-pg2.yml:kas/opt/secure-boot.yml:kas/opt/otpcmd/key-provision-keys-only.yml
```

### Enable secure boot only

If you want to only enable the secure boot(because the keys are already programmed):

```bash
./kas-container build kas-iot2050-boot-pg2.yml:kas/opt/secure-boot.yml:kas/opt/otpcmd/key-provision-enabling-only.yml
```

### Switch from SMPK to BMPK

If the key switching is from SMPK to BMPK:

```bash
./kas-container build kas-iot2050-boot-pg2.yml:kas/opt/secure-boot.yml:kas/opt/otpcmd/key-switch-2to3.yml
```

### Use TUI alternative

Above options could also be achieved by:

```bash
./kas-container menu
```

Then 

- select `Firmware image for PG2 devices` as the `Image type`
- check `Secure boot` and `OTP provisioning` in `Image features`
- select among `OTP provisioning command type`

You can double confirm your selection in generated `.config.yaml`.

## Security Notice

Please securely take care of the generated keys, for example, storing it in a
safe place. Better to use a HSM to securely generating and storing the keys.

After generating the OTP programming firmware, transfer it to the device in a
securely manner to keep the integrity of the firmware.
